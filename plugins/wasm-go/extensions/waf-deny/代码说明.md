# 代码说明

## 代码结构
目前的代码由于经过多轮调整，还处在优化中的阶段，**尚未完成**！因此，目前的结构属于一个半成品的结构。插件的主要代码逻辑在 wasmplugin 目录中，主要组成部分如下：

- **core**： 用于定义基本的数据结构和基础函数。
- **go_rules**：用于实现各种 WAF 规则逻辑
- **rule_tasks**：用于存放各种规则的参数。

## WAF 规则主要实现方法

WAF 规则的主要来源是 OWASP 规则集，参考了 coraza 。 规则的实现主要是采用"自动机"的思路。

### 技术选型

在经过多轮调整和优化后，选择了"语义分析"这一思路，并通过 Ragel 自动机实现这一思路。

之所以会选择 Ragel 来实现"语义分析"的思路，主要是基于以下考虑：
1. 从理解成本来看，"语义分析"的代码相较于正则表达式，其理解难度低了很多，便于分享各种规则逻辑。
2. 从实现成本看，在 OWASP 规则集中，如果一个规则比较复杂，往往先要用 regex-assembly 工具先写 xxx.ra 文件，再根据 .ra 文件生成正则表达式，最后用 go 代码去执行这个正则表达式。其可读性较好的是 .ra 文件。但由于.ra的目的是为了生成正则表达式，因此其可读性相较于语义分析的代码而言，一般会较差。而采用"语义分析"的自动机时，可以直接用较少的代码写出自动机逻辑，再直接编译为 go 代码，实现成本较低。
3. 从性能来看，一个实现较好的 Ragel 自动机性能将大幅由于正则表达式。以 LDAP 注入检测为例，通过简单的性能测试，若直接输入原数据，Ragel 的性能是正则表达式的 2 倍；而输入经过加工后的数据时，Ragel 的性能达到了正则表达式的 7-10倍。

### 代码文件说明

xxx.rl: Ragel 文件
xxx.go: 如果是 rl 的同名文件，则是通过 Ragel 编译后的 go 文件，可直接使用。
RuleXXX.go: 未迁移到 Ragel 自动机的规则代码，用 go 语言硬编码而成，主要是执行规则集中的正则表达式。这部分文件属于过渡阶段的文件，当整个项目完成时，这部分文件都会融合到 Ragel 自动机中。

### TODO

由于代码技术选型的探索工作耗时较长和编码时间的限制，本项目的代码改造仅进行了 40-50% 左右。除了规则迁移未完成外，还有以下不足：

1. Ragel 的资料较少，入门有一定的门槛，一开始较难写出优秀的实现，如果写得不好，其性能甚至不如正则表达式。
2. 应探索 WAF 领域是否还有更优秀的实现，比如雷池 WAF 的规则引擎采用的是 "偃师" 自研引擎，应探索其优点。
3. 不仅仅是规则执行的逻辑，数据处理等模块的逻辑也应该继续优化，各模块间的职责、交互应该更加明晰。
4. 应该实现规则的分层逻辑，比如 xss / sqli 等规则，是"平衡防护"还是"高强度防护"，应该支持配置。

