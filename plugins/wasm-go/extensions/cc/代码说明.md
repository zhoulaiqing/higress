# 代码说明

## 数据结构和逻辑

本插件采用的限流逻辑在包 `sliding_hist_limiter` 中。主要实现思路如下：

1. 当一次请求发生时，将某个请求的时间戳存入对应的key（比如规则配置的 head 或 cookie）的请求历史(`history`)列表中。
2. 在这次请求时，如果 `history` 列表有已经过期的时间戳（比如我们规则配置最大是按日，那么 24 小时之前的时间戳就没什么用了），则把这部分数据删除
3. 计算 `history` 中的时间戳是否超过限制。具体逻辑是：如果配置了该key 一分钟3个请求限制，那么，则统计 【history 中存储的时间戳 > 一分钟前的时间戳】的记录数，如果数量超过了3，则命中限制规则。
4. 在存入 `SharedData` 时，将 `history` 和 `blockUntil` (表示该key关小黑屋的到期时间，如果没有设置则为0)合并成一个数组，存入到 SharedData 中。

## 废弃的逻辑
代码中 `qps_limiter` 属于已经不再使用的逻辑，可忽略。(还保留在代码中是因为这个 `limiter` 逻辑简单，可以起到充当一个 demo 示例的作用)

## TODO

目前没有实现 key 的自动过期机制，是等到下次请求才触发 `history` 中过期记录（时间戳）的删除操作。




